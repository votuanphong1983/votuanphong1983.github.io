<!doctype html>
<html>

<head>
    <title>DEC Miners Index</title>
    <meta name="description" content="DEC Miners Index">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <style>
        .header {
            display: flex;
            font-weight: bold;
            margin-left: 40px;
        }

        .save-btn {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .index {
            display: flex;
        }

        .account {
            min-width: 180px;
            color: lightseagreen;
            font-weight: bold;
            cursor: pointer;
        }

        .power {
            font-weight: normal;
            color: orange;
        }

        .dec {
            min-width: 150px;
            color: black;
            display: flex;
        }

        .period-earning {
            min-width: 120px;
            color: black;
            display: flex;
        }

        .ok-pe {
            color: green;
        }

        .no-pe {
            color: red;
        }

        .unit {
            color: blue;
            margin-left: 8px;
        }

        .rating {
            margin-left: 50px;
            min-width: 120px;
        }

        .rate {
            min-width: 150px;
        }

        .quest {
            min-width: 150px;
        }

        .quest-ok {
            font-weight: bold;
            color: green;
        }

        .owner {
            font-weight: bold;
            color: binance-com;
            font-size: 30px;
        }
    </style>
</head>

<body>
    <h3>DEC Miners Index</h3>
    <button class="save-btn" style="display: none;" onclick="perisistData();"> Save </button>

    <div class="header">
        <div class="account">Account</div>
        <div class="dec">DEC Balance</div>
        <div class="period-earning pe-header">N/A</div>
        <div class="rating">Rating</div>
        <div class="rate">Capture Rate</div>
        <div class="rate">Quest comleted?</div>
    </div>
    <ul id="indexes"></ul>

    <script>
        const persistIntervalMinutes = 240; // 4 hours
        const storageKey = "sps";
        const storage = localStorage;
        const savedData = JSON.parse(storage.getItem(storageKey));
        const accountsInfo = [];
        const timestamp = new Date().getTime();

        $(document).ready(async () => {
            const accList = [
				"binance-com",
				"--------BOT1--------",
                "sps.gamer2000",
                "sps.gamer2001",
                "sps.gamer2002",
                "sps.gamer2003",
                "sps.gamer2004",
                "sps.gamer2005",
				"sps.gamer2006",
				"sps.gamer2007",
				"sps.gamer2008",
				"sps.gamer2009",
				"--------BOT2--------",
				"sps.gamer2010",
				"sps.gamer2011",
				"sps.gamer2012",
                "sps.gamer2013",
                "sps.gamer2014",
                "sps.gamer2015",
				"sps.gamer2016",
				"sps.gamer2017",
				"sps.gamer2018",
				"sps.gamer2019",
				"--------BOT3--------",
				"dec-miner1",
                "dec-miner2",
                "dec-miner3",
                "dec-miner4",
                "dec-miner5",
                "dec-miner6",
                "dec-miner7",
                "dec-miner8",
				"dec-miner9",
                "dec-miner10",
				"--------BOT4--------",
				"sps.gamer2020",
				"sps.gamer2021",
				"sps.gamer2022",
				"sps.gamer2023",
				"sps.gamer2024",
				"crypto-com",
                "dec-miner"
            ];

            if (savedData) {
                $(".pe-header").html(`Earning in ${Math.round((timestamp - savedData?.timestamp) / 60000)} mins`);
            }

            for (const account of accList) {
                if (account.startsWith("-")) {
                    $("#indexes").append(`<li><div>${account}</div></li>`);
                } else {
                    const data = await getData(account);
                    accountsInfo.push(data);

                    if (savedData) {
                        const last = savedData?.data?.find(x => x.account === account);

                        // Calculation
						calculatePlayersDetail(last, data);
                    }

                    // Rendering
                    renderAccount(data);
                }
            }

            // Check and persist data to storage
            checkAndPersistData();

            $(".save-btn").css("display", "block");
        });

        function checkCards(username) {
            window.open(`https://peakmonsters.com/@${username}/cards`);
        }

        function getData(username) {
            return Promise.all([
				new Promise((resolve, reject) => {    
					$.ajax({
						timeout: 3000,
						url: "https://game-api.splinterlands.io/players/balances?username=" + username,
						context: document,
					    error: function(){
							resolve({});
						},
						success: function(x){						
							resolve(x);
						},
					})
				}),
				new Promise((resolve, reject) => {    
					$.ajax({
						timeout: 3000,
						url: "https://game-api.splinterlands.io/players/quests?username=" + username,
						context: document,
					    error: function(){
							resolve({});
						},
						success: function(x){						
							resolve(x);
						},
					})
				}),
				new Promise((resolve, reject) => {    
					$.ajax({
						timeout: 3000,
						url: "https://game-api.splinterlands.io/players/details?name=" + username,
						context: document,
					    error: function(){
							resolve({});
						},
						success: function(x){						
							resolve(x);
						},
					})
				})                
            ]).then((results) => {
                const balance = results[0];
                const quest = results[1][0];
                const playerD = results[2] ?? {};

                return {
                    account: username,
                    balance: balance?.filter(x => x.token === 'DEC')?.[0],
                    detail: playerD,
                    quest
                };
            });
        }

        function renderAccount(account) {
            const dec = account.balance;
            const rating = account.detail.rating;
            const rate = account.detail.capture_rate / 100;

            const questStatus = account.quest?.completed_items + '/' + account.quest?.total_items
            const questClass = account.quest?.completed_items == account.quest?.total_items ? 'quest-ok' : '';
           
			  const li = [];
                const peClass = account.periodEarning > 0 ? 'ok-pe' : 'no-pe';
				const pcClass = account.detail.collection_power >= 1000 ? 'ok-pe' : 'no-pe';
                li.push(
                    `<div class="account" onclick="checkCards('${account.account}')">${account.account} <span class='${pcClass}'>(${account.detail.collection_power})</span></div>`,
                    `<div class="dec">${dec?.balance.toFixed(2)}<div class="unit">DEC</div></div>`,
                    `<div class="period-earning ${peClass}">${savedData ? `${account.periodEarning.toFixed(2)} <div class="unit">DEC</div>` : ''}</div>`,
                    `<div class="rating">${rating}</div>`,
                    `<div class="rate">${rate}%</div>`,
                    `<div class="quest ${questClass}">${questStatus}</div>`
                );
                $('#indexes').append(`<li><div class="index">${li.join("")}</div></li>`);
        }

        function checkAndPersistData() {
            if (savedData) {
                // Check period to see if it is time to persist new data
                if ((timestamp - savedData.timestamp) / 60000 >= persistIntervalMinutes) {
                    perisistData();
                }
            } else {
                // First perisistent
                perisistData();
            }
        }

        function perisistData() {
            const toSave = JSON.stringify({
                timestamp,
                data: accountsInfo
            });
            storage.setItem(storageKey, toSave);
        }

        function calculatePlayersDetail(savedData, currentData) {
		    if (!currentData || !savedData) {
			  currentData.periodEarning = 0;
			}
			else {
			   currentData.periodEarning = (currentData.balance?.balance ?? 0) - savedData.balance?.balance ?? 0;
			}
			           
        }
    </script>
</body>

</html>
